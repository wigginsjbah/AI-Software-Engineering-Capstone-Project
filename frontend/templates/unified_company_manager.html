<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company & Database Manager - Business Intelligence Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(-45deg, #667eea, #764ba2, #6c7ce0, #8b7ec8);
            background-size: 400% 400%;
            animation: gradientShift 70s ease infinite;
            min-height: 100vh;
            color: #333;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .header {
            background: linear-gradient(-45deg, #667eea, #764ba2, #6c7ce0, #8b7ec8);
            background-size: 400% 400%;
            animation: gradientShift 70s ease infinite;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header-nav {
            margin-top: 15px;
        }

        .nav-link {
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            margin: 0 5px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
            display: inline-block;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .nav-link.active {
            background: rgba(255,255,255,0.95);
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .business-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .business-type-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }

        .business-type-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .business-type-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .business-type-option h4 {
            margin-bottom: 5px;
        }

        .business-type-option p {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .company-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            position: relative;
        }

        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .company-card.active {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);
        }

        .company-card.active::before {
            content: "ACTIVE";
            position: absolute;
            top: 15px;
            right: 15px;
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .company-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .company-meta {
            margin: 15px 0;
            font-size: 0.9em;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            align-items: center;
        }

        .business-type-badge {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .company-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .company-actions .btn {
            padding: 10px 18px;
            font-size: 0.85em;
            border-radius: 6px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toolbar Styles */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Empty State Styles */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }

        .advanced-options {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .advanced-options h4 {
            margin-bottom: 15px;
            color: #495057;
        }

        .complexity-options {
            display: flex;
            gap: 15px;
            margin: 10px 0;
        }

        .complexity-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .complexity-option:hover {
            border-color: #667eea;
        }

        .complexity-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .requirements-list {
            margin-top: 10px;
        }

        .requirement-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .requirement-item input {
            flex: 1;
            margin: 0;
        }

        .remove-requirement {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .add-requirement {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Generation Method Toggle Styles - Horizontal and Centered */
        .generation-method-toggle {
            margin-bottom: 40px;
            display: flex;
            justify-content: center;
            padding: 0;
            background: none;
            border: none;
            backdrop-filter: none;
        }

        .toggle-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .toggle-label {
            color: white;
            font-weight: 600;
            font-size: 1.2em;
            white-space: nowrap;
        }

        .toggle-switch {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .toggle-switch input[type="radio"] {
            display: none;
        }

        .toggle-switch label {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            font-size: 1.1em;
        }

        .toggle-switch label:hover {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        .toggle-switch input[type="radio"]:checked + label {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* Generation Form Styles */
        .generation-form {
            display: none;
        }

        .generation-form.active {
            display: block;
        }

        /* Upload Area Styles */
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f9f9f9;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-content h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .upload-content p {
            color: #666;
            margin: 0;
        }

        .upload-browse {
            color: #667eea;
            font-weight: 600;
            text-decoration: underline;
        }

        #fileInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* File Preview Styles */
        .file-preview {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: #e9ecef;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-icon {
            font-size: 1.5em;
        }

        .file-details h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .file-details p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .file-remove:hover {
            background: #c82333;
        }

        /* Upload Info Boxes */
        .upload-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .info-box h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .info-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .info-box li {
            color: #444;
            margin-bottom: 8px;
            padding-left: 0;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* Processing Options */
        .processing-options {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 10px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .option-item:last-child {
            margin-bottom: 0;
        }

        .option-item input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }

        .option-item label {
            margin: 0;
            color: #333;
            cursor: pointer;
        }

        /* Small Data Source Toggle */
        .data-source-toggle {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
        }

        .small-toggle-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px 25px;
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .small-toggle-label {
            color: #333;
            font-weight: 600;
            font-size: 1em;
            white-space: nowrap;
        }

        .small-toggle-switch {
            display: flex;
            gap: 15px;
        }

        .small-toggle-switch input[type="radio"] {
            display: none;
        }

        .small-toggle-switch label {
            background: rgba(255, 255, 255, 0.8);
            color: #666;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            font-size: 0.9em;
        }

        .small-toggle-switch label:hover {
            background: rgba(255, 255, 255, 1);
            color: #333;
        }

        .small-toggle-switch input[type="radio"]:checked + label {
            background: #667eea;
            color: white;
            border-color: #5a6fd8;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Page Section Styles */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        @media (max-width: 768px) {
            .upload-info {
                grid-template-columns: 1fr;
            }
            
            .tab-navigation {
                flex-direction: column;
            }
        }

        .preview-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
        }

        .schema-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .schema-table th,
        .schema-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .schema-table th {
            background: #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            border-bottom: 2px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .business-type-grid {
                grid-template-columns: 1fr;
            }
            
            .complexity-options {
                flex-direction: column;
            }
            
            .company-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 data-translate="page_title">üóÑÔ∏è Database Management</h1>
        <p data-translate="page_subtitle">Create companies and generate or upload business databases</p>
        <div class="header-nav">
            <a href="/" class="nav-link" data-translate="chat_interface">Chat Interface</a>
            <a href="/companies" class="nav-link" data-translate="companies">Companies</a>
            <a href="/databases" class="nav-link active" data-translate="databases">Databases</a>
            
            <!-- Language Toggle -->
            <div style="display: inline-flex; align-items: center; margin-left: 20px;">
                <span style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-right: 8px;" data-translate="language">Language:</span>
                <button 
                    id="language-toggle"
                    onclick="toggleLanguage()" 
                    style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
                           border-radius: 6px; color: white; padding: 5px 10px; font-size: 0.8rem; 
                           cursor: pointer; transition: all 0.3s ease;"
                    onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <span id="current-lang">EN</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- Company Creation Section -->
            <div class="section">
                <h2 class="section-title" data-translate="create_section_title">üè¢ Create New Company & Database</h2>
                
                <!-- Data Source Toggle -->
                <div class="data-source-toggle">
                    <div class="small-toggle-container">
                        <span class="small-toggle-label" data-translate="data_source_label">Data Source:</span>
                        <div class="small-toggle-switch">
                            <input type="radio" id="aiGenerated" name="dataSource" value="ai" checked>
                            <label for="aiGenerated">
                                <span data-translate="ai_generated">AI Generated</span>
                            </label>
                            <input type="radio" id="uploadFiles" name="dataSource" value="upload">
                            <label for="uploadFiles">
                                <span data-translate="upload_files">Upload Files</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- AI Generation Form -->
                <div id="ai-generation-form" class="generation-form active">
                
                <form id="companyForm">
                    <!-- Basic Company Information -->
                    <div class="form-group">
                        <label for="companyName" data-translate="company_name_label">Company Name *</label>
                        <input type="text" id="companyName" name="companyName" required 
                               data-translate-placeholder="company_name_placeholder">
                    </div>

                    <div class="form-group">
                        <label for="companyDescription" data-translate="description_label">Company Description *</label>
                        <textarea id="companyDescription" name="companyDescription" required 
                                  data-translate-placeholder="description_placeholder"></textarea>
                    </div>

                    <!-- Business Type Selection -->
                    <div class="form-group">
                        <label data-translate="business_type_label">Business Type *</label>
                        <div class="business-type-grid">
                            <div class="business-type-option" data-type="retail">
                                <h4 data-translate="retail_title">üõçÔ∏è Retail</h4>
                                <p data-translate="retail_desc">E-commerce, stores, products, customers</p>
                            </div>
                            <div class="business-type-option" data-type="healthcare">
                                <h4 data-translate="healthcare_title">üè• Healthcare</h4>
                                <p data-translate="healthcare_desc">Patients, treatments, medical records</p>
                            </div>
                            <div class="business-type-option" data-type="finance">
                                <h4 data-translate="finance_title">üí∞ Finance</h4>
                                <p data-translate="finance_desc">Accounts, transactions, investments</p>
                            </div>
                            <div class="business-type-option" data-type="education">
                                <h4 data-translate="education_title">üéì Education</h4>
                                <p data-translate="education_desc">Students, courses, grades, schools</p>
                            </div>
                            <div class="business-type-option" data-type="manufacturing">
                                <h4 data-translate="manufacturing_title">üè≠ Manufacturing</h4>
                                <p data-translate="manufacturing_desc">Production, inventory, supply chain</p>
                            </div>
                            <div class="business-type-option" data-type="ecommerce">
                                <h4 data-translate="ecommerce_title">üõí E-commerce</h4>
                                <p data-translate="ecommerce_desc">Online sales, digital marketplace</p>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Database Options -->
                    <div class="advanced-options">
                        <h4 data-translate="database_config_title">üîß Database Configuration</h4>
                        
                        <div class="form-group">
                            <label data-translate="complexity_label">Database Complexity</label>
                            <div class="complexity-options">
                                <div class="complexity-option selected" data-complexity="simple">
                                    <h5 data-translate="simple_title">Simple</h5>
                                    <p data-translate="simple_desc">Basic tables, ideal for MVPs</p>
                                </div>
                                <div class="complexity-option" data-complexity="medium">
                                    <h5 data-translate="medium_title">Medium</h5>
                                    <p data-translate="medium_desc">Standard business logic</p>
                                </div>
                                <div class="complexity-option" data-complexity="complex">
                                    <h5 data-translate="complex_title">Complex</h5>
                                    <p data-translate="complex_desc">Advanced relationships & features</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label data-translate="specific_requirements_label">Specific Requirements (Optional)</label>
                            <div class="requirements-list" id="requirementsList">
                                <div class="requirement-item">
                                    <input type="text" data-translate-placeholder="requirements_placeholder" placeholder="e.g., Multi-tenant architecture, audit logging, etc.">
                                    <button type="button" class="remove-requirement" onclick="removeRequirement(this)" data-translate="remove_button">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="add-requirement" onclick="addRequirement()" data-translate="add_requirement_button">+ Add Requirement</button>
                        </div>

                        <div class="form-group">
                            <label for="additionalContext" data-translate="additional_context_label">Additional Context (Optional)</label>
                            <textarea id="additionalContext" name="additionalContext" 
                                      data-translate-placeholder="additional_context_placeholder" placeholder="Any additional information about your business logic, special requirements, or preferences..."></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-secondary" onclick="previewSchema()" data-translate="preview_schema_button">
                            üîç Preview Schema
                        </button>
                        <button type="submit" class="btn btn-success" data-translate="create_database_button">
                            üöÄ Create Company & Generate Database
                        </button>
                    </div>
                </form>

                <!-- Preview/Results Section -->
                <div class="preview-section" id="previewSection">
                    <div class="info">
                        <strong data-translate="how_it_works_title">üí° How it works:</strong>
                        <ol>
                            <li data-translate="how_it_works_step1">Fill in your company details and select business type</li>
                            <li data-translate="how_it_works_step2">Preview the AI-generated database schema (optional)</li>
                            <li data-translate="how_it_works_step3">Create your company with a fully functional database</li>
                            <li data-translate="how_it_works_step4">Start chatting with your business data immediately!</li>
                        </ol>
                    </div>
                </div>
                </div>

                <!-- Manual Upload Form -->
                <div id="upload-generation-form" class="generation-form">
                    <div class="upload-info">
                        <div class="info-box">
                            <h4>üéØ Supported Formats</h4>
                            <ul>
                                <li>üìä <strong>Excel Files:</strong> .xlsx, .xls (Multiple sheets supported)</li>
                                <li>üìÑ <strong>CSV Files:</strong> .csv (Comma-separated values)</li>
                                <li>üíæ <strong>Database Files:</strong> .sqlite, .db</li>
                                <li>üìÑ <strong>JSON Files:</strong> .json (Structured data)</li>
                                <li>üìã <strong>Text Files:</strong> .txt (Tab-delimited)</li>
                            </ul>
                        </div>
                        
                        <div class="info-box">
                            <h4>üí° Tips for Best Results</h4>
                            <ul>
                                <li>Include column headers for better data recognition</li>
                                <li>Ensure consistent data formats (dates, numbers)</li>
                                <li>Multiple files will be automatically linked when possible</li>
                                <li>Large files (>50MB) may take longer to process</li>
                            </ul>
                        </div>
                    </div>
                    
                    <form id="uploadForm" enctype="multipart/form-data">
                        <!-- Basic Company Information -->
                        <div class="form-group">
                            <label for="uploadCompanyName" data-translate="company_name_label">Company Name *</label>
                            <input type="text" id="uploadCompanyName" name="companyName" required 
                                   data-translate-placeholder="company_name_placeholder">
                        </div>

                        <div class="form-group">
                            <label for="uploadCompanyDescription" data-translate="description_label">Company Description *</label>
                            <textarea id="uploadCompanyDescription" name="companyDescription" required 
                                      data-translate-placeholder="description_placeholder"></textarea>
                        </div>

                        <!-- File Upload Section -->
                        <div class="form-group">
                            <label data-translate="upload_files_label">üìÅ Upload Your Data Files</label>
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-content">
                                    <div class="upload-icon">üì§</div>
                                    <h3 data-translate="drag_drop_title">Drag & Drop Files Here</h3>
                                    <p><span data-translate="upload_or_text">or</span> <span class="upload-browse" data-translate="upload_browse_text">click to browse</span></p>
                                    <input type="file" id="fileInput" name="files" multiple 
                                           accept=".xlsx,.xls,.csv,.sqlite,.db,.json,.txt">
                                </div>
                            </div>
                            
                            <!-- File Preview -->
                            <div id="filePreview" class="file-preview"></div>
                        </div>

                        <!-- Data Processing Options -->
                        <div class="form-group">
                            <label data-translate="processing_options_label">‚öôÔ∏è Processing Options</label>
                            <div class="processing-options">
                                <div class="option-item">
                                    <input type="checkbox" id="autoDetectRelations" checked>
                                    <label for="autoDetectRelations" data-translate="auto_detect_label">Auto-detect relationships between tables</label>
                                </div>
                                <div class="option-item">
                                    <input type="checkbox" id="normalizeData" checked>
                                    <label for="normalizeData" data-translate="normalize_data_label">Normalize data formats (dates, numbers)</label>
                                </div>
                                <div class="option-item">
                                    <input type="checkbox" id="createIndexes" checked>
                                    <label for="createIndexes" data-translate="create_indexes_label">Create database indexes for better performance</label>
                                </div>
                                <div class="option-item">
                                    <input type="checkbox" id="validateData">
                                    <label for="validateData" data-translate="validate_data_label">Validate data integrity (slower but more reliable)</label>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary" onclick="previewUploadedData()" 
                                    id="previewUploadBtn" disabled data-translate="preview_data_button">
                                üîç Preview Data
                            </button>
                            <button type="submit" class="btn btn-success" id="uploadSubmitBtn" disabled data-translate="create_from_upload_button">
                                üìÅ Create Company from Upload
                            </button>
                        </div>
                    </form>

                    <!-- Upload Preview Section -->
                    <div class="preview-section" id="uploadPreviewSection" style="display: none;">
                        <h4 data-translate="data_preview_title">üìä Data Preview</h4>
                        <div id="uploadPreviewContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedBusinessType = null;
        let selectedComplexity = 'simple';
        let currentSchema = null;
        let currentSampleData = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // Business type selection
            document.querySelectorAll('.business-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.business-type-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedBusinessType = this.dataset.type;
                });
            });

            // Complexity selection
            document.querySelectorAll('.complexity-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.complexity-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedComplexity = this.dataset.complexity;
                });
            });

            // Form submission
            document.getElementById('companyForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createCompanyWithDatabase();
            });

            // Upload form submission
            document.getElementById('uploadForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await createCompanyFromUpload();
            });

            // Data source toggle handlers
            setupDataSourceToggle();

            // File upload handlers
            setupFileUpload();
        }

        // Data Source Toggle Functions
        function setupDataSourceToggle() {
            const toggleRadios = document.querySelectorAll('input[name="dataSource"]');
            
            toggleRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    switchDataSource(this.value);
                });
            });
        }

        function switchDataSource(source) {
            // Hide all forms
            document.querySelectorAll('.generation-form').forEach(form => {
                form.classList.remove('active');
            });
            
            // Show selected form
            if (source === 'ai') {
                document.getElementById('ai-generation-form').classList.add('active');
            } else if (source === 'upload') {
                document.getElementById('upload-generation-form').classList.add('active');
            }
        }

        // Global helper functions for file handling
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'xlsx': 'üìä', 'xls': 'üìä',
                'csv': 'üìÑ', 'txt': 'üìÑ',
                'sqlite': 'üíæ', 'db': 'üíæ',
                'json': 'üóÇÔ∏è'
            };
            return icons[ext] || 'üìÅ';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // File Upload Functions
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const filePreview = document.getElementById('filePreview');
            const previewBtn = document.getElementById('previewUploadBtn');
            const submitBtn = document.getElementById('uploadSubmitBtn');
            
            let uploadedFiles = [];

            // Drag and drop handlers
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // Click to open file dialog
            uploadArea.addEventListener('click', (e) => {
                e.preventDefault();
                fileInput.click();
            });

            // File input change handler
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            function handleFiles(files) {
                Array.from(files).forEach(file => {
                    if (validateFile(file)) {
                        uploadedFiles.push(file);
                    }
                });
                displayFiles();
                updateButtons();
            }

            function validateFile(file) {
                const allowedTypes = [
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                    'application/vnd.ms-excel', // .xls
                    'text/csv', // .csv
                    'application/vnd.sqlite3', // .sqlite
                    'application/x-sqlite3', // .db
                    'application/json', // .json
                    'text/plain' // .txt
                ];

                const maxSize = 100 * 1024 * 1024; // 100MB

                if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv|sqlite|db|json|txt)$/i)) {
                    alert(`File type not supported: ${file.name}`);
                    return false;
                }

                if (file.size > maxSize) {
                    alert(`File too large: ${file.name}. Maximum size is 100MB.`);
                    return false;
                }

                return true;
            }

            function displayFiles() {
                filePreview.innerHTML = '';
                uploadedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    const fileIcon = getFileIcon(file.name);
                    const fileSize = formatFileSize(file.size);
                    
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">${fileIcon}</div>
                            <div class="file-details">
                                <h4>${file.name}</h4>
                                <p>${fileSize} ‚Ä¢ ${file.type || 'Unknown type'}</p>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button type="button" class="file-remove" onclick="removeFile(${index})">
                                Remove
                            </button>
                        </div>
                    `;
                    
                    filePreview.appendChild(fileItem);
                });
            }

            function updateButtons() {
                const hasFiles = uploadedFiles.length > 0;
                previewBtn.disabled = !hasFiles;
                submitBtn.disabled = !hasFiles;
            }

            // Make removeFile globally accessible
            window.removeFile = function(index) {
                uploadedFiles.splice(index, 1);
                displayFiles();
                updateButtons();
            };

            // Make uploadedFiles accessible globally
            window.getUploadedFiles = function() {
                return uploadedFiles;
            };
        }

        // Preview uploaded data
        async function previewUploadedData() {
            const files = window.getUploadedFiles();
            if (files.length === 0) return;

            const previewSection = document.getElementById('uploadPreviewSection');
            const previewContent = document.getElementById('uploadPreviewContent');
            
            if (!previewSection || !previewContent) {
                console.error('Upload preview elements not found');
                alert('Upload preview elements not found. Please reload the page.');
                return;
            }
            
            previewContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing uploaded files...</p></div>';
            previewSection.style.display = 'block';

            try {
                // For now, just show file information
                // In a real implementation, this would send files to backend for analysis
                let previewHtml = '<div class="upload-analysis">';
                previewHtml += '<h5>üìã File Analysis Summary</h5>';
                
                files.forEach((file, index) => {
                    previewHtml += `
                        <div class="analysis-item">
                            <h6>${getFileIcon(file.name)} ${file.name}</h6>
                            <p>Size: ${formatFileSize(file.size)}</p>
                            <p>Type: ${file.type || 'Unknown'}</p>
                            <p>Status: Ready for processing</p>
                        </div>
                    `;
                });
                
                previewHtml += '</div>';
                previewContent.innerHTML = previewHtml;

            } catch (error) {
                previewContent.innerHTML = `<div class="error">Error analyzing files: ${error.message}</div>`;
            }
        }

        // Create company from uploaded files
        async function createCompanyFromUpload() {
            const companyNameElement = document.getElementById('uploadCompanyName');
            const companyDescElement = document.getElementById('uploadCompanyDescription');
            
            if (!companyNameElement || !companyDescElement) {
                showPreview('error', 'Required form fields not found', 'previewSection');
                return;
            }
            
            const companyName = companyNameElement.value;
            const companyDescription = companyDescElement.value;
            const files = window.getUploadedFiles();

            if (!companyName || !companyDescription || files.length === 0) {
                alert('Please fill in all required fields and upload at least one file.');
                return;
            }

            const submitBtn = document.getElementById('uploadSubmitBtn');
            if (!submitBtn) {
                showPreview('error', 'Submit button not found', 'previewSection');
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ Creating Company...';
            submitBtn.disabled = true;

            try {
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('company_name', companyName);
                formData.append('company_description', companyDescription);
                formData.append('business_type', 'custom'); // Mark as custom upload
                
                // Processing options with null checks
                const autoDetectElement = document.getElementById('autoDetectRelations');
                const normalizeElement = document.getElementById('normalizeData');
                const createIndexesElement = document.getElementById('createIndexes');
                const validateElement = document.getElementById('validateData');
                
                formData.append('auto_detect_relations', autoDetectElement ? autoDetectElement.checked : false);
                formData.append('normalize_data', normalizeElement ? normalizeElement.checked : false);
                formData.append('create_indexes', createIndexesElement ? createIndexesElement.checked : false);
                formData.append('validate_data', validateElement ? validateElement.checked : false);

                // Add all files
                files.forEach((file) => {
                    formData.append('files', file);  // Use 'files' as the parameter name
                });

                const response = await fetch('/api/companies/create-from-upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showUploadMessage('success', `‚úÖ Company "${companyName}" created successfully from uploaded files!`);
                    
                    // Clear form with null checks
                    const uploadForm = document.getElementById('uploadForm');
                    const filePreview = document.getElementById('filePreview');
                    
                    if (uploadForm) uploadForm.reset();
                    if (filePreview) filePreview.innerHTML = '';
                    
                    // Switch back to AI generation
                    const aiRadio = document.getElementById('aiGenerated');
                    if (aiRadio) {
                        aiRadio.checked = true;
                        switchDataSource('ai');
                    }
                    
                    // Reload companies list
                    await loadCompanies();
                } else {
                    const errorMessage = result.error || result.detail || 'Unknown server error';
                    throw new Error(errorMessage);
                }

            } catch (error) {
                console.error('Upload error:', error);
                let errorMessage = error.message;
                
                // Handle specific error types
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to server. Please make sure the server is running.';
                } else if (error.message.includes('413') || error.message.includes('too large')) {
                    errorMessage = 'File too large. Please try smaller files or fewer files.';
                } else if (error.message.includes('422')) {
                    errorMessage = 'Invalid file format or data. Please check your files and try again.';
                }
                
                showUploadMessage('error', errorMessage);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Helper function for fetch with timeout
        async function fetchWithTimeout(url, options, timeout = 180000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out. Please try with a simpler description or lower complexity.');
                }
                throw error;
            }
        }

        function getFormData() {
            const requirements = [];
            document.querySelectorAll('#requirementsList input').forEach(input => {
                if (input.value.trim()) {
                    requirements.push(input.value.trim());
                }
            });

            return {
                business_type: selectedBusinessType,
                complexity: selectedComplexity,
                company_description: document.getElementById('companyDescription').value,
                specific_requirements: requirements,
                include_sample_data: true,
                sample_data_size: 'medium',
                additional_context: document.getElementById('additionalContext').value
            };
        }

        async function previewSchema() {
            if (!validateForm()) return;

            showPreview('loading', 'Generating schema preview...');

            try {
                const formData = getFormData();
                const response = await fetchWithTimeout('/api/v1/database/generate/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                }, 60000);

                const result = await response.json();

                if (result.success) {
                    currentSchema = result.schema;
                    displaySchemaPreview(result.schema);
                    showPreview('success', `‚úÖ Schema preview generated in ${result.generation_time_seconds}s`);
                } else {
                    handleApiError(result, 'schema preview');
                }
            } catch (error) {
                handleNetworkError(error, 'schema preview');
            }
        }

        async function createCompanyWithDatabase() {
            if (!validateForm()) return;

            showPreview('loading', 'Creating company with enhanced database generation...<br><small>This may take 3-5 minutes for comprehensive data. Please be patient...</small>', 'previewSection');

            try {
                // Get form data with null checks
                const formData = new FormData();
                const companyNameElement = document.getElementById('companyName');
                const companyDescElement = document.getElementById('companyDescription');
                const additionalContextElement = document.getElementById('additionalContext');
                
                if (!companyNameElement || !companyDescElement) {
                    showPreview('error', 'Required form fields not found', 'previewSection');
                    return;
                }
                
                formData.append('company_name', companyNameElement.value);
                formData.append('company_description', companyDescElement.value);
                formData.append('business_type', selectedBusinessType);
                formData.append('complexity', selectedComplexity);
                
                // Add requirements
                const requirements = [];
                document.querySelectorAll('#requirementsList input').forEach(input => {
                    if (input.value.trim()) {
                        requirements.push(input.value.trim());
                    }
                });
                formData.append('requirements', requirements.join(','));
                
                // Add additional context with null check
                const additionalContext = additionalContextElement ? additionalContextElement.value : '';
                if (additionalContext) {
                    formData.append('additional_context', additionalContext);
                }

                // Call enhanced API endpoint
                const response = await fetchWithTimeout('/api/companies/create-enhanced', {
                    method: 'POST',
                    body: formData
                }, 300000); // 5 minute timeout for enhanced generation

                const result = await response.json();

                if (response.ok) {
                    // Show success with detailed stats
                    let successMessage = `üéâ Enhanced Company "${result.company_name}" created successfully!<br><br>`;
                    successMessage += `üìä <strong>Generated Data:</strong><br>`;
                    if (result.data_stats) {
                        Object.entries(result.data_stats).forEach(([key, value]) => {
                            successMessage += `‚Ä¢ ${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}<br>`;
                        });
                    }
                    successMessage += `<br>You can now start chatting with your comprehensive business data!`;
                    
                    showPreview('success', successMessage, 'previewSection');
                    document.getElementById('companyForm').reset();
                    resetSelections();
                    await loadCompanies();
                } else {
                    handleApiError(result, 'enhanced company creation');
                }

            } catch (error) {
                console.error('Enhanced creation error:', error);
                if (error.name === 'AbortError') {
                    showPreview('error', '‚è∞ Request timed out. Enhanced database generation can take several minutes. Please try again or use the simple complexity option.', 'previewSection');
                } else {
                    showPreview('error', `‚ùå Error creating enhanced company: ${error.message}`, 'previewSection');
                }
            }
        }

        function validateForm() {
            const nameElement = document.getElementById('companyName');
            const descriptionElement = document.getElementById('companyDescription');
            
            if (!nameElement || !descriptionElement) {
                showPreview('error', 'Form elements not found. Please reload the page.', 'previewSection');
                return false;
            }
            
            const name = nameElement.value.trim();
            const description = descriptionElement.value.trim();

            if (!name) {
                showPreview('error', 'Please enter a company name.', 'previewSection');
                return false;
            }

            if (!description || description.length < 10) {
                showPreview('error', 'Please provide a detailed company description (at least 10 characters).', 'previewSection');
                return false;
            }

            if (!selectedBusinessType) {
                showPreview('error', 'Please select a business type.', 'previewSection');
                return false;
            }

            return true;
        }

        function resetSelections() {
            selectedBusinessType = null;
            selectedComplexity = 'simple';
            document.querySelectorAll('.business-type-option').forEach(opt => 
                opt.classList.remove('selected'));
            document.querySelectorAll('.complexity-option').forEach(opt => 
                opt.classList.remove('selected'));
            document.querySelector('[data-complexity="simple"]').classList.add('selected');
        }

        function showPreview(type, message, targetId = 'previewSection') {
            try {
                const previewSection = document.getElementById(targetId);
                
                if (!previewSection) {
                    console.error(`${targetId} element not found`);
                    // Create a temporary alert if the preview section is not available
                    alert(`${type.toUpperCase()}: ${message.replace(/<[^>]*>/g, '')}`);
                    return;
                }
                
                if (type === 'loading') {
                    previewSection.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <div>${message}</div>
                        </div>
                    `;
                } else if (type === 'error') {
                    previewSection.innerHTML = `
                        <div class="error">
                            <strong>‚ùå Error:</strong> ${message}
                            <br><br>
                            <small>
                                <strong>Tips:</strong>
                                <ul style="margin: 10px 0;">
                                    <li>Make sure your company description is detailed and specific</li>
                                    <li>Try a simpler complexity level if generation fails</li>
                                    <li>Check that the server is running and API keys are configured</li>
                                </ul>
                            </small>
                        </div>
                    `;
                } else if (type === 'success') {
                    previewSection.innerHTML = `<div class="success">${message}</div>`;
                }

                // Show the preview section with additional null check
                if (previewSection) {
                    previewSection.style.display = 'block';
                }
            } catch (error) {
                console.error('Error in showPreview function:', error);
                alert(`${type.toUpperCase()}: ${message.replace(/<[^>]*>/g, '')}`);
            }
        }

        function showUploadMessage(type, message) {
            showPreview(type, message, 'uploadPreviewSection');
        }

        function displaySchemaPreview(schema) {
            const previewSection = document.getElementById('previewSection');
            
            let tablesHtml = '';
            schema.tables.forEach(table => {
                tablesHtml += `
                    <h4>${table.name}</h4>
                    <table class="schema-table">
                        <thead>
                            <tr>
                                <th>Column</th>
                                <th>Type</th>
                                <th>Constraints</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${table.columns.map(col => `
                                <tr>
                                    <td>${col.name}</td>
                                    <td>${col.type}</td>
                                    <td>${col.constraints || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            });

            previewSection.innerHTML = `
                <h3>üìã Database Schema Preview</h3>
                ${tablesHtml}
                <div style="margin-top: 20px;">
                    <p><strong>Tables:</strong> ${schema.tables.length}</p>
                    <p><strong>Total Columns:</strong> ${schema.tables.reduce((sum, table) => sum + table.columns.length, 0)}</p>
                </div>
            `;
        }

        function handleApiError(result, operation) {
            let errorMessage = `Failed to ${operation}`;
            if (result.error) {
                errorMessage = result.error;
            } else if (result.detail) {
                errorMessage = result.detail;
            } else if (result.message) {
                errorMessage = result.message;
            } else if (typeof result === 'object') {
                const keys = Object.keys(result);
                if (keys.length > 0) {
                    const firstKey = keys[0];
                    const firstValue = result[firstKey];
                    if (typeof firstValue === 'string') {
                        errorMessage = `${firstKey}: ${firstValue}`;
                    } else {
                        errorMessage = `${operation} failed - ${keys.join(', ')} in response`;
                    }
                }
            }
            showPreview('error', errorMessage, 'previewSection');
            console.error(`${operation} error:`, result);
        }

        function handleNetworkError(error, operation) {
            let errorMessage = `Error during ${operation}: ${error.message}`;
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                errorMessage = 'Cannot connect to server. Please ensure the server is running.';
            } else if (error.message.includes('JSON')) {
                errorMessage = 'Server returned invalid response format.';
            } else if (error.message.includes('NetworkError')) {
                errorMessage = 'Network connection failed. Check your internet connection.';
            }
            showPreview('error', errorMessage, 'previewSection');
            console.error(`${operation} network error:`, error);
        }

        async function loadCompanies() {
            const container = document.getElementById('companiesContainer');
            
            if (!container) {
                console.error('Companies container not found');
                return;
            }
            
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading companies...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/companies');
                const result = await response.json();

                if (response.ok) {
                    displayCompanies(result.companies || []);
                } else {
                    container.innerHTML = `
                        <div class="error">
                            Failed to load companies: ${result.detail || result.message || 'Unknown error'}
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="error">
                        Error loading companies: ${error.message}
                    </div>
                `;
            }
        }

        function displayCompanies(companies) {
            const container = document.getElementById('companiesContainer');
            
            if (!container) {
                console.error('Companies container not found in displayCompanies');
                return;
            }
            
            if (!companies || companies.length === 0) {
                container.innerHTML = `
                    <div class="info">
                        <strong>üìù No companies yet</strong><br>
                        Create your first company using the form on the left to get started!
                    </div>
                `;
                return;
            }

            const companiesHtml = companies.map(company => `
                <div class="company-card ${company.is_active ? 'active' : ''}">
                    <div class="company-name">${company.name}</div>
                    <div class="company-meta">
                        <div class="meta-row">
                            <span>Type:</span>
                            <span class="business-type-badge">${company.business_type}</span>
                        </div>
                        <div class="meta-row">
                            <span>Created:</span>
                            <span>${new Date(company.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="meta-row">
                            <span>ID:</span>
                            <span style="font-family: monospace; font-size: 0.8em;">${company.id}</span>
                        </div>
                    </div>
                    <div class="company-actions">
                        ${!company.is_active ? `
                            <button class="btn btn-success" onclick="setActiveCompany('${company.id}')">
                                üîÑ Activate
                            </button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="deleteCompany('${company.id}', '${company.name}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="company-grid">${companiesHtml}</div>`;
        }

        async function setActiveCompany(companyId) {
            try {
                const response = await fetch('/api/companies/switch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ company_id: companyId })
                });

                if (response.ok) {
                    await loadCompanies();
                    showPreview('success', '‚úÖ Company activated successfully! The chat interface will now use this company\'s data.');
                    
                    // Notify parent window if opened from another page
                    if (window.opener) {
                        window.opener.postMessage({ type: 'companyChanged' }, '*');
                    }
                } else {
                    const error = await response.json();
                    showPreview('error', `Failed to activate company: ${error.detail || error.message}`);
                }
            } catch (error) {
                showPreview('error', `Error activating company: ${error.message}`);
            }
        }

        async function deleteCompany(companyId, companyName) {
            if (!confirm(`Are you sure you want to delete "${companyName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/companies/${companyId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadCompanies();
                    showPreview('success', `‚úÖ Company "${companyName}" deleted successfully!`);
                } else {
                    const error = await response.json();
                    showPreview('error', `Failed to delete company: ${error.detail || error.message}`);
                }
            } catch (error) {
                showPreview('error', `Error deleting company: ${error.message}`);
            }
        }

        function addRequirement() {
            const list = document.getElementById('requirementsList');
            const item = document.createElement('div');
            item.className = 'requirement-item';
            item.innerHTML = `
                <input type="text" placeholder="Enter specific requirement...">
                <button type="button" class="remove-requirement" onclick="removeRequirement(this)">Remove</button>
            `;
            list.appendChild(item);
        }

        function removeRequirement(button) {
            const list = document.getElementById('requirementsList');
            if (list.children.length > 1) {
                button.parentElement.remove();
            }
        }

        // ===== LANGUAGE SUPPORT SYSTEM =====
        
        // Translation dictionaries
        const translations = {
            en: {
                page_title: "Company & Database Manager",
                page_subtitle: "Create and manage companies with AI-powered database generation",
                chat_interface: "Chat Interface",
                companies: "Companies",
                databases: "Databases",
                language: "Language:",
                create_section_title: "Create New Company & Database",
                data_source_label: "Data Source:",
                ai_generated: "AI Generated",
                upload_files: "Upload Files",
                remove_button: "Remove",
                add_requirement_button: "+ Add Requirement",
                preview_schema_button: "üîç Preview Schema",
                create_database_button: "üöÄ Create Company & Generate Database",
                create_company: "Create New Company",
                company_name_label: "Company Name *",
                company_name_placeholder: "Enter your company name",
                description_label: "Company Description *",
                description_placeholder: "Describe your business, products, services, and target market in detail...",
                business_type_label: "Business Type *",
                retail_title: "Retail",
                retail_desc: "E-commerce, stores, products, customers",
                healthcare_title: "Healthcare", 
                healthcare_desc: "Patients, treatments, medical records",
                finance_title: "Finance",
                finance_desc: "Accounts, transactions, investments",
                education_title: "Education",
                education_desc: "Students, courses, grades, schools",
                manufacturing_title: "Manufacturing",
                manufacturing_desc: "Production, inventory, supply chain",
                ecommerce_title: "E-commerce",
                ecommerce_desc: "Online sales, digital marketplace",
                database_config_title: "üîß Database Configuration",
                complexity_label: "Database Complexity",
                simple_title: "Simple",
                simple_desc: "Basic tables, ideal for MVPs",
                medium_title: "Medium",
                medium_desc: "Standard business logic",
                complex_title: "Complex",
                complex_desc: "Advanced relationships & features",
                create_button: "Create Company",
                existing_companies: "üìä Existing Companies",
                no_companies: "üìù No companies yet",
                no_companies_desc: "Create your first company using the form on the left to get started!",
                activate: "üîÑ Activate",
                delete: "üóëÔ∏è Delete",
                specific_requirements_label: "Specific Requirements (Optional)",
                requirements_placeholder: "e.g., Multi-tenant architecture, audit logging, etc.",
                additional_context_label: "Additional Context (Optional)",
                additional_context_placeholder: "Any additional information about your business logic, special requirements, or preferences...",
                how_it_works_title: "üí° How it works:",
                how_it_works_step1: "Fill in your company details and select business type",
                how_it_works_step2: "Preview the AI-generated database schema (optional)",
                how_it_works_step3: "Create your company with a fully functional database",
                how_it_works_step4: "Start chatting with your business data immediately!",
                upload_files_label: "üìÅ Upload Your Data Files",
                drag_drop_title: "Drag & Drop Files Here",
                upload_or_text: "or",
                upload_browse_text: "click to browse",
                processing_options_label: "‚öôÔ∏è Processing Options",
                auto_detect_label: "Auto-detect relationships between tables",
                normalize_data_label: "Normalize data formats (dates, numbers)",
                create_indexes_label: "Create database indexes for better performance",
                validate_data_label: "Validate data integrity (slower but more reliable)",
                preview_data_button: "üîç Preview Data",
                create_from_upload_button: "üìÅ Create Company from Upload",
                data_preview_title: "üìä Data Preview"
            },
            es: {
                page_title: "Gestor de Empresas y Bases de Datos",
                page_subtitle: "Crear y gestionar empresas con generaci√≥n de bases de datos impulsada por IA",
                chat_interface: "Interfaz de Chat",
                companies: "Empresas",
                databases: "Bases de Datos",
                language: "Idioma:",
                create_section_title: "Crear Nueva Empresa y Base de Datos",
                data_source_label: "Fuente de Datos:",
                ai_generated: "Generado por IA",
                upload_files: "Subir Archivos",
                remove_button: "Eliminar",
                add_requirement_button: "+ Agregar Requisito",
                preview_schema_button: "üîç Vista Previa del Esquema",
                create_database_button: "üöÄ Crear Empresa y Generar Base de Datos",
                create_company: "Crear Nueva Empresa",
                company_name_label: "Nombre de la Empresa *",
                company_name_placeholder: "Ingresa el nombre de tu empresa",
                description_label: "Descripci√≥n de la Empresa *",
                description_placeholder: "Describe tu negocio, productos, servicios y mercado objetivo en detalle...",
                business_type_label: "Tipo de Negocio *",
                retail_title: "Minorista",
                retail_desc: "Comercio electr√≥nico, tiendas, productos, clientes",
                healthcare_title: "Salud",
                healthcare_desc: "Pacientes, tratamientos, registros m√©dicos",
                finance_title: "Finanzas",
                finance_desc: "Cuentas, transacciones, inversiones",
                education_title: "Educaci√≥n",
                education_desc: "Estudiantes, cursos, calificaciones, escuelas",
                manufacturing_title: "Manufactura",
                manufacturing_desc: "Producci√≥n, inventario, cadena de suministro",
                ecommerce_title: "Comercio Electr√≥nico",
                ecommerce_desc: "Ventas en l√≠nea, mercado digital",
                database_config_title: "üîß Configuraci√≥n de Base de Datos",
                complexity_label: "Complejidad de Base de Datos",
                simple_title: "Simple",
                simple_desc: "Tablas b√°sicas, ideal para MVPs",
                medium_title: "Medio",
                medium_desc: "L√≥gica empresarial est√°ndar",
                complex_title: "Complejo",
                complex_desc: "Relaciones y caracter√≠sticas avanzadas",
                create_button: "Crear Empresa",
                existing_companies: "üìä Empresas Existentes",
                no_companies: "üìù A√∫n no hay empresas",
                no_companies_desc: "¬°Crea tu primera empresa usando el formulario de la izquierda para comenzar!",
                activate: "üîÑ Activar",
                delete: "üóëÔ∏è Eliminar",
                specific_requirements_label: "Requisitos Espec√≠ficos (Opcional)",
                requirements_placeholder: "ej., Arquitectura multi-inquilino, registro de auditor√≠a, etc.",
                additional_context_label: "Contexto Adicional (Opcional)",
                additional_context_placeholder: "Cualquier informaci√≥n adicional sobre tu l√≥gica de negocio, requisitos especiales o preferencias...",
                how_it_works_title: "üí° C√≥mo funciona:",
                how_it_works_step1: "Completa los detalles de tu empresa y selecciona el tipo de negocio",
                how_it_works_step2: "Previsualiza el esquema de base de datos generado por IA (opcional)",
                how_it_works_step3: "Crea tu empresa con una base de datos completamente funcional",
                how_it_works_step4: "¬°Comienza a chatear con los datos de tu negocio inmediatamente!",
                upload_files_label: "üìÅ Sube Tus Archivos de Datos",
                drag_drop_title: "Arrastra y Suelta Archivos Aqu√≠",
                upload_or_text: "o",
                upload_browse_text: "haz clic para explorar",
                processing_options_label: "‚öôÔ∏è Opciones de Procesamiento",
                auto_detect_label: "Detectar autom√°ticamente relaciones entre tablas",
                normalize_data_label: "Normalizar formatos de datos (fechas, n√∫meros)",
                create_indexes_label: "Crear √≠ndices de base de datos para mejor rendimiento",
                validate_data_label: "Validar integridad de datos (m√°s lento pero m√°s confiable)",
                preview_data_button: "üîç Previsualizar Datos",
                create_from_upload_button: "üìÅ Crear Empresa desde Carga",
                data_preview_title: "üìä Vista Previa de Datos"
            }
        };

        // Current language state
        let currentLanguage = localStorage.getItem('chatbot-language') || 'en';

        // Language toggle function
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
            localStorage.setItem('chatbot-language', currentLanguage);
            updateLanguageDisplay();
            updateTranslations();
        }

        // Update language display
        function updateLanguageDisplay() {
            document.getElementById('current-lang').textContent = currentLanguage.toUpperCase();
            document.documentElement.lang = currentLanguage;
        }

        // Update all translations on the page
        function updateTranslations() {
            const elementsToTranslate = document.querySelectorAll('[data-translate]');
            elementsToTranslate.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            // Handle placeholder translations
            const elementsWithPlaceholders = document.querySelectorAll('[data-translate-placeholder]');
            elementsWithPlaceholders.forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
        }

        // Initialize language on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateLanguageDisplay();
            updateTranslations();
        });
    </script>
</body>
</html>